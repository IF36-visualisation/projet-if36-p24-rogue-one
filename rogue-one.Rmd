---
title: "Rogue One project"
author: "JAULIN Maxence, PRODHON Louis, GIROD Mathis, WANG Zezhong"
output:
  html_document: default
---

```{r setup}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(readr)
library(lubridate)
library(forcats)
```

# Projet Rogue One

Ce projet a pour but de découvrir, traiter et analyser les données provenant de différents jeux de données provenants de la SNCF.

### Première étape : du CSV aux datasets

Récupération des jeux de données SNCF :

-   Gares de voyageurs : gares

-   Fréquentation des gares : frequentation

-   Motif de déplacement des voyageurs : motif_depl

-   Catégorie socio-professionelle des voyageurs : CSP_voya

-   Classe d'âge des voyageurs : age_voya

-   Objets perdus : obj_perdus

-   Objets trouvés : obj_trouves

```{r}
gares <- read_delim(file = "data/dataset1-gares-de-voyageurs.csv", delim=";")
frequentation <- read_delim(file = "data/dataset2-frequentation-gares.csv", delim=";")
motif_depl <- read_delim(file = "data/dataset3-motif-deplacement.csv", delim=";")
CSP_voya <- read_delim(file = "data/dataset4-enquetes-gares-connexions-repartition-par-repartition-par-categories-socio-profe.csv", delim=";")
age_voya <- read_delim(file = "data/dataset5-enquetes-gares-connexions-repartition-repartition-par-classe-dage.csv", delim=";")
#obj_perdus <- read_delim(file = "data/dataset6-objets-trouves-gares.csv", delim=";")
#obj_trouves <- read_delim(file = "data/dataset7-objets-trouves-restitution.csv", delim=";")

```

**Fréquentation des gares**

```{r}
freq <- frequentation %>%
  select(gare = "Nom de la gare", voyageurs = "Total Voyageurs + Non voyageurs 2022") %>%
  filter(voyageurs > 20000000)

ggplot(data = freq, mapping=aes(x=voyageurs,y=gare))+geom_col()
```

```{r}
colnames(frequentation)

```

## Voyageurs

Afin de mieux comprendre les voyageurs, nous avons choisi de nous intéresser aux différents profils qui utilisent les trains des réseaux ferrés de France.

Dans un premier temps, nous analysons le nombre de voyageurs par département, pour nous intéresser ensuite à la proportion de voyageurs dans les gares d'un même département.

*Le nombre de voyageurs est-il bien repartis entre les gares d'un même département ?*

**Nombre de voyageurs total par département (2022)**

```{r}
freq <- frequentation %>%
  rename(code_postal = 'Code postal')

freq <- freq %>%
  rename(passagers2022 = 'Total Voyageurs 2022')

freq <- freq %>%
  mutate(code_postal = as.character(code_postal))

frequentation <- freq %>%
  mutate(departement = substr(code_postal, 1, 2))

departement_passagers <- frequentation %>%
  group_by(departement) %>%
  summarize(total_passagers = sum(passagers2022))

ggplot(departement_passagers, aes(x = total_passagers, y = departement)) +
  geom_bar(stat = "identity") +
  labs(title = "Répartition des voyageurs entre les départements en 2022",
       x = "Nombre total de passagers",
       y = "Département")

```

**Répartition du nombre de voyageurs dans les gares d'un même département.** Exemple département (77)

Grâce à cette visusalisation, on peut connaître les gares les plus importantes en termes de fréquentation dans chacun des départements.

Dans le cas du département 77 et du premier jet de visualisation, on observe que la gare de Melun est très fréquentée comparé aux autres gares.

```{r}
freq <- frequentation %>%
  rename(gare = 'Nom de la gare')

gares_77 <- freq %>%
  filter(departement == "77")

ggplot(gares_77, aes(x = passagers2022, y = gare)) +
  geom_bar(stat = "identity") +
  labs(title = "Repartition des voyageurs dans les gares du département 77",
       x = "Nombre de passagers",
       y = "Gare")

```

## Objets perdus/restitués

Dans cette partie, nous voulons nous intéresser plus particulièrement aux objets.

Tout d'abord, petite visualisation du dataset obj_perdus

```{r}
head(obj_perdus)
summary(obj_perdus)
```

Quelque chose m'interpelle dès le début : c'est la colonne "Type d'enregistrement", il semble que celle-ci est toujours remplie de la même manière

```{r}
enregistrement <- obj_perdus %>%
  select(en = `Type d'enregistrement`)
diff_enre <- n_distinct(enregistrement)
```

C'est donc le cas, donc nous n'utiliserons pas cette colonne.

On distingue aussi que de nombreuses gares ne sont pas présentes.

Nous voulons effectuer plusieurs réductions sur ce jeu de données. Tout d'abord, les informations que nous avons datent de 2019 jusqu'à nos jours. Si nous voulons faire des recoupements avec le dataset de voyageur, nous allons restreindre les dates à 2019 seulement car les années 2020 et 2021 ne sont pas forcément représentatives du traffic ferroviaire normal. L'année 2022 sera analysée prochainement pour voir si une tendance peut commencer à apparaître.

```{r}
obj_perdus_2019 <- obj_perdus %>%
  select(date = `Date de la déclaration de perte`, gare = "Gare", UIC = "Code UIC", nature = "Nature d'objets", type = "Type d'objets") %>%
  filter(date < ymd(20200101)) %>% 
  filter(date > ymd(20190101))
count(obj_perdus_2019)
```

Nous avons donc maintenant 185 065 entrées dans notre dataframe.

Découvrons ce que celui-ci nous cache dans la répartition des objets perdus :

```{r}
obj_perdus_2019 %>% 
  ggplot(aes(y=fct_rev(fct_infreq(type)))) +
  geom_bar() +
  labs(title = "Nombre d'objets perdus par type d'objets en 2019",
       y = "Type d'objet",
       x = "Nombre d'objets perdus en unité")
```

Sans surprise, les objets les plus couramment perdus sont donc dans l'ordre :

-   Bagages

-   Appareils électroniques

-   Vêtements
