---
title: "Rogue One project"
author: "JAULIN Maxence, PRODHON Louis, GIROD Mathis, WANG Zezhong"
output:
  html_document: default
---

```{r setup}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(readr)
library(lubridate)
library(forcats)
```

# Projet Rogue One

Ce projet a pour but de découvrir, traiter et analyser les données provenant de différents jeux de données provenants de la SNCF.

### Première étape : du CSV aux datasets

Récupération des jeux de données SNCF :

-   Gares de voyageurs : gares

-   Fréquentation des gares : frequentation

-   Motif de déplacement des voyageurs : motif_depl

-   Catégorie socio-professionelle des voyageurs : CSP_voya

-   Classe d'âge des voyageurs : age_voya

-   Objets perdus : obj_perdus

-   Objets trouvés : obj_trouves

```{r}
gares <- read_delim(file = "data/dataset1-gares-de-voyageurs.csv", delim=";")

frequentation <- read_delim(file = "data/dataset2-frequentation-gares.csv", delim=";")

motif_depl <- read_delim(file = "data/dataset3-motif-deplacement.csv", delim=";")

CSP_voya <- read_delim(file = "data/dataset4-enquetes-gares-connexions-repartition-par-repartition-par-categories-socio-profe.csv", delim=";")

age_voya <- read_delim(file = "data/dataset5-enquetes-gares-connexions-repartition-repartition-par-classe-dage.csv", delim=";")

obj_perdus <- read_delim(file = "data/dataset6-objets-trouves-gares.csv", delim=";")

obj_trouves <- read_delim(file = "data/dataset7-objets-trouves-restitution.csv", delim=";")

```

Premier test de visualisation de la fréquentation des gares

```{r}
freq <- frequentation %>%
  select(gare = "Nom de la gare", voyageurs = "Total Voyageurs + Non voyageurs 2022") %>%
  filter(voyageurs > 20000000)

ggplot(data = freq, mapping=aes(x=voyageurs,y=gare))+geom_col()
```

```{r}
colnames(frequentation)

```

Nombre de voyageurs total par départements (2022)

```{r}
freq <- frequentation %>%
  rename(code_postal = 'Code postal')

freq <- freq %>%
  rename(passagers2022 = 'Total Voyageurs 2022')

freq <- freq %>%
  mutate(code_postal = as.character(code_postal))

frequentation <- freq %>%
  mutate(departement = substr(code_postal, 1, 2))

departement_passagers <- frequentation %>%
  group_by(departement) %>%
  summarize(total_passagers = sum(passagers2022))

ggplot(departement_passagers, aes(x = total_passagers, y = departement)) +
  geom_bar(stat = "identity") +
  labs(title = "Répartition des voyageurs entre les départements en 2022",
       x = "Nombre total de passagers",
       y = "Département")

```

```{r}

```

## Objets perdus/restitués

Dans cette partie, nous voulons nous intéresser plus particulièrement aux objets.

Tout d'abord, petite visualisation du dataset obj_perdus

```{r}
head(obj_perdus)
summary(obj_perdus)
```

Quelque chose m'interpelle dès le début : c'est la colonne "Type d'enregistrement", il semble que celle-ci est toujours remplie de la même manière

```{r}
enregistrement <- obj_perdus %>%
  select(en = `Type d'enregistrement`)
diff_enre <- n_distinct(enregistrement)
```

C'est donc le cas, donc nous n'utiliserons pas cette colonne.

On distingue aussi que de nombreuses gares ne sont pas présentes.

Nous voulons effectuer plusieurs réductions sur ce jeu de données. Tout d'abord, les informations que nous avons datent de 2019 jusqu'à nos jours. Si nous voulons faire des recoupements avec le dataset de voyageur, nous allons restreindre les dates à 2019 seulement car les années 2020 et 2021 ne sont pas forcément représentatives du traffic ferroviaire normal. L'année 2022 sera analysée prochainement pour voir si une tendance peut commencer à apparaître.

```{r}
obj_perdus_2019 <- obj_perdus %>%
  select(date = `Date de la déclaration de perte`, gare = "Gare", UIC = "Code UIC", nature = "Nature d'objets", type = "Type d'objets") %>%
  filter(date < ymd(20200101)) %>% 
  filter(date > ymd(20190101))
count(obj_perdus_2019)
```

Nous avons donc maintenant 185 065 entrées dans notre dataframe.

Découvrons ce que celui-ci nous cache dans la répartition des objets perdus :

```{r}
obj_perdus_2019 %>% 
  ggplot(aes(y=fct_infreq(type))) + geom_bar()
```
